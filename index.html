<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>BudgetWise Lite</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b1220; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --accent:#22c55e; --warn:#f59e0b; --bad:#ef4444; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, #172554 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:960px; margin:0 auto; padding:18px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, #22c55e, #3b82f6);
      display:grid; place-items:center; font-weight:800; color:#081018;
      box-shadow: 0 10px 30px rgba(34,197,94,.2);
    }
    h1{font-size:18px; margin:0}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(17,24,39,.92);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    input, select, button{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b1220;
      color:var(--text);
      outline:none;
    }
    input[type="date"]{padding:10px 12px}
    button{
      cursor:pointer; border:none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color:#06110a; font-weight:700;
    }
    button.secondary{
      background:#0b1220; border:1px solid var(--border); color:var(--text); font-weight:600;
    }
    button.danger{
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color:#120606;
    }
    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      padding:12px; border-radius:16px; border:1px solid var(--border); background:#0b1220;
    }
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{font-size:18px; font-weight:800; margin-top:4px}
    .bar{height:10px; background:#0b1220; border:1px solid var(--border); border-radius:999px; overflow:hidden; margin-top:10px}
    .bar > div{height:100%; width:0%}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0b1220; color:var(--muted); font-size:12px}
    .list{margin-top:10px}
    .item{
      display:grid; grid-template-columns: 1fr auto; gap:10px;
      padding:12px; border-radius:16px; border:1px solid var(--border); background:#0b1220;
      margin-top:10px;
    }
    .item .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .item .amt{font-weight:900}
    .item .actions{display:flex; gap:8px; align-items:start}
    .mini{padding:8px 10px; border-radius:12px; font-size:12px}
    .toast{
      display:none;
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; max-width:92vw;
      background:#0b1220; border:1px solid var(--border);
      padding:10px 12px; border-radius:999px; color:var(--text);
      box-shadow:0 12px 35px rgba(0,0,0,.35);
    }
    .toast.show{display:block}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--border); margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">‚Ç¨</div>
        <div>
          <h1>BudgetWise Lite</h1>
          <div class="sub">Budget giornaliero + spese variabili + spese fisse ‚Äúa data scelta‚Äù</div>
        </div>
      </div>
      <div class="row" style="max-width:420px; width:100%">
        <div>
          <label>Giorno</label>
          <input id="day" type="date" />
        </div>
        <div>
          <label>Budget (‚Ç¨)</label>
          <input id="budget" type="number" step="0.01" inputmode="decimal" placeholder="es. 35" />
        </div>
        <div style="align-self:end">
          <button id="saveBudget">Salva</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="t">Speso</div>
            <div class="v" id="kSpent">0,00 ‚Ç¨</div>
          </div>
          <div class="kpi">
            <div class="t">Rimanente</div>
            <div class="v" id="kLeft">0,00 ‚Ç¨</div>
          </div>
          <div class="kpi">
            <div class="t">Percentuale</div>
            <div class="v" id="kPct">0%</div>
          </div>
        </div>

        <div class="bar" aria-label="progress">
          <div id="barFill"></div>
        </div>

        <div class="divider"></div>

        <!-- SPESE VARIABILI -->
        <div class="pill">üßæ Spese (variabili)</div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Importo (‚Ç¨)</label>
            <input id="amount" type="number" step="0.01" inputmode="decimal" placeholder="es. 4,50" />
          </div>
          <div>
            <label>Categoria</label>
            <select id="cat">
              <option>Cibo</option>
              <option>Trasporti</option>
              <option>Casa</option>
              <option>Svago</option>
              <option>Salute</option>
              <option>Altro</option>
            </select>
          </div>
        </div>

        <label>Nota</label>
        <input id="note" type="text" placeholder="es. caff√® + cornetto" />

        <div class="row" style="margin-top:10px">
          <button id="add">Aggiungi spesa</button>
          <button id="export" class="secondary">Esporta CSV</button>
        </div>

        <div class="list" id="list"></div>

        <div class="divider"></div>

        <!-- SPESE FISSE A DATA SCELTA -->
        <div class="pill">üìå Spese fisse (con data scelta)</div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Importo fisso (‚Ç¨)</label>
            <input id="f_amount" type="number" step="0.01" inputmode="decimal" placeholder="es. 9,99" />
          </div>
          <div>
            <label>Categoria</label>
            <select id="f_cat">
              <option>Abbonamenti</option>
              <option>Casa</option>
              <option>Trasporti</option>
              <option>Salute</option>
              <option>Altro</option>
            </select>
          </div>
        </div>

        <label>Nota</label>
        <input id="f_note" type="text" placeholder="es. Spotify / palestra / bolletta" />

        <label>Data in cui viene conteggiata</label>
        <input id="f_day" type="date" />

        <div class="row" style="margin-top:10px">
          <button id="f_add">Aggiungi spesa fissa</button>
          <button id="f_export" class="secondary">Esporta fisse CSV</button>
        </div>

        <div class="list" id="fixedList"></div>
      </div>

      <!-- STRUMENTI -->
      <div class="card">
        <div class="pill">‚öôÔ∏è Strumenti</div>

        <label>Avviso superamento</label>
        <select id="alertMode">
          <option value="on">Mostra avviso</option>
          <option value="off">Nessun avviso</option>
        </select>

        <label>Reset giorno selezionato (variabili + fisse di quel giorno)</label>
        <button id="resetDay" class="danger">Azzera quel giorno</button>

        <div class="divider"></div>

        <div class="pill">üîí Privacy</div>
        <p class="muted" style="margin:10px 0 0; font-size:13px; line-height:1.45">
          Tutti i dati restano nel telefono/browser. Nessun server.
        </p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script defer>
(() => {
  const $ = (id) => document.getElementById(id);

  const KEY = "bw_lite_v2_fixed_by_date";
  const state = load();

  // Data di oggi
  const today = new Date();
  const iso = today.toISOString().slice(0,10);
  $("day").value = iso;
  $("f_day").value = iso;

  // impostazioni
  $("alertMode").value = state.settings.alertMode ?? "on";

  // prima render
  syncBudgetInput();
  render();

  // EVENTI
  $("day").addEventListener("change", () => { syncBudgetInput(); render(); });

  $("saveBudget").addEventListener("click", () => {
    const day = $("day").value;
    const b = num($("budget").value);
    if (!day) return;
    if (!isFinite(b) || b < 0) return toast("Scrivi un budget giusto.");
    state.budgets[day] = round2(b);
    save(state);
    toast("Budget salvato ‚úÖ");
    render();
  });

  $("add").addEventListener("click", () => {
    const day = $("day").value;
    const amount = num($("amount").value);
    const cat = $("cat").value;
    const note = $("note").value.trim();

    if (!day) return;
    if (!isFinite(amount) || amount <= 0) return toast("Scrivi un importo > 0.");

    state.expenses.push({
      id: cryptoId(),
      ts: Date.now(),
      day,
      amount: round2(amount),
      cat,
      note
    });
    save(state);

    $("amount").value = "";
    $("note").value = "";

    render();
    maybeAlert();
  });

  // Spesa fissa: conta SOLO nella data scelta
  $("f_add").addEventListener("click", () => {
    const amount = num($("f_amount").value);
    const cat = $("f_cat").value;
    const note = $("f_note").value.trim();
    const fday = $("f_day").value;

    if (!isFinite(amount) || amount <= 0) return toast("Scrivi un importo fisso > 0.");
    if (!fday) return toast("Scegli una data.");

    state.fixed.push({
      id: cryptoId(),
      day: fday,
      amount: round2(amount),
      cat,
      note
    });
    save(state);

    $("f_amount").value = "";
    $("f_note").value = "";
    $("f_day").value = $("day").value; // comodo: torna al giorno selezionato

    toast("Spesa fissa aggiunta ‚úÖ");
    render();
    maybeAlert();
  });

  $("resetDay").addEventListener("click", () => {
    const day = $("day").value;
    if (!day) return;

    const beforeV = state.expenses.length;
    const beforeF = state.fixed.length;

    state.expenses = state.expenses.filter(e => e.day !== day);
    state.fixed = state.fixed.filter(f => f.day !== day);

    save(state);

    const removed = (beforeV - state.expenses.length) + (beforeF - state.fixed.length);
    toast(removed ? "Giorno azzerato üßπ" : "Niente da cancellare.");
    render();
  });

  $("export").addEventListener("click", () => exportCSVVariabili());

  $("f_export").addEventListener("click", () => exportCSVFisse());

  $("alertMode").addEventListener("change", () => {
    state.settings.alertMode = $("alertMode").value;
    save(state);
  });

  // PWA offline
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }

  // FUNZIONI DATI
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return { budgets:{}, expenses:[], fixed:[], settings:{ alertMode:"on" } };
      const parsed = JSON.parse(raw);
      return {
        budgets: parsed.budgets || {},
        expenses: Array.isArray(parsed.expenses) ? parsed.expenses : [],
        fixed: Array.isArray(parsed.fixed) ? parsed.fixed : [],
        settings: parsed.settings || { alertMode:"on" }
      };
    } catch {
      return { budgets:{}, expenses:[], fixed:[], settings:{ alertMode:"on" } };
    }
  }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function todayBudget(day){ return num(state.budgets[day] ?? 0); }

  function dayExpenses(day){
    return state.expenses
      .filter(e => e.day === day)
      .sort((a,b) => b.ts - a.ts);
  }

  function fixedForDay(day){
    return (state.fixed || [])
      .filter(f => f.day === day);
  }

  function totals(day){
    const b = todayBudget(day);
    const varSpent = round2(dayExpenses(day).reduce((sum,e)=>sum+e.amount, 0));
    const fixedSpent = round2(fixedForDay(day).reduce((sum,f)=>sum+f.amount, 0));
    const spent = round2(varSpent + fixedSpent);
    const left = round2(b - spent);
    const pct = b > 0 ? Math.min(200, Math.round((spent / b) * 100)) : 0;
    return { b, spent, left, pct, varSpent, fixedSpent };
  }

  // RENDER
  function syncBudgetInput(){
    const day = $("day").valu
